# Igloo Server

A server-based signing device and personal ephemeral relay for the **FROSTR** protocol. Part of the FROSTR ecosystem of k-of-n remote signing clients for Nostr, providing an always-on signing node with optional web UI for configuration and monitoring.

Built on [@frostr/igloo-core](https://github.com/FROSTR-ORG/igloo-core) for reliable FROSTR protocol operations.

## What is FROSTR?

**FROSTR** is a simple k-of-n remote signing and key management protocol for Nostr, using the powers of FROST. It allows you to break up an existing **nsec** into fragments called "shares" and create any kind of multi-signature setup using your shares and signing devices. If one share is compromised, your secret key remains safe, and your **npub** and signatures don't change - nobody knows you're using a multi-sig.

## Features

### 🔐 **FROSTR Signing Node**
- **Always-On Operation**: Persistent signing node that handles Nostr signature requests automatically
- **Share-Based Security**: Uses FROST threshold signatures with your nsec shares - never reconstructs the full private key
- **Multi-Relay Support**: Connects to multiple Nostr relays for redundancy and coordination
- **Real-time Monitoring**: Live peer status tracking and event logging

### 🌐 **Modern Web Interface** 
- **React Frontend**: Modern, responsive UI built with TypeScript and Tailwind CSS
- **Configuration Management**: Set up credentials, manage relays, and monitor status
- **Key Recovery**: Intuitive interface for recovering secrets from threshold shares
- **Live Event Logs**: Real-time visibility into signing operations and network events
- **Peer Management**: Monitor other nodes in your signing group with ping/status tracking

### 📡 **Ephemeral Nostr Relay**
- **In-Memory Storage**: Temporarily caches events without persistent database
- **WebSocket Support**: Full NIP-01 compliant Nostr relay implementation  
- **Auto-Purging**: Configurable memory cleanup (default: 30 seconds)
- **Development Ready**: Perfect for testing and coordination within your signing network

### ⚙️ **Flexible Operation Modes**
- **Web UI Mode**: Full React interface for interactive management
- **Headless Mode**: Server-only operation via environment variables and APIs
- **API Access**: RESTful endpoints for programmatic control
- **Event Streaming**: Server-Sent Events for real-time updates

## Architecture

The server provides three integrated services:

1. **FROSTR Signing Node** - Built on igloo-core with bifrost protocol implementation
2. **Web Interface** - React frontend for configuration and monitoring  
3. **Ephemeral Relay** - In-memory Nostr relay for network coordination

## Quick Start

### Prerequisites

- **Bun runtime** (recommended) or Node.js 18+
- **FROSTR credentials** (group + share) from your nsec shares generated by Igloo Desktop

### Installation & Setup

```bash
# Clone the repository
git clone https://github.com/FROSTR-ORG/igloo-server.git
cd igloo-server

# Install dependencies
bun install

# Build the frontend
bun run build

# Start the server
bun run start
```

The server will be available at **http://localhost:8002**

### Configuration Options

#### Option 1: Web Interface (Recommended)
1. Open http://localhost:8002 in your browser
2. Use the **Configure** tab to enter your credentials:
   - **Group Credential** (`bfgroup1...`)
   - **Share Credential** (`bfshare1...`)
   - **Relay URLs** (optional - defaults to `wss://relay.primal.net`)
3. Switch to the **Signer** tab to start your signing node
4. Monitor operations in the **Event Log** and **Peer List**

#### Option 2: Headless Mode
Set environment variables and run the server directly:

```bash
# Create .env file
cat > .env << EOF
GROUP_CRED=bfgroup1qqsqp...your-group-credential
SHARE_CRED=bfshare1qqsqp...your-share-credential
RELAYS=["wss://relay.primal.net","wss://relay.damus.io"]
GROUP_NAME=my-signing-group
EOF

# Start server (node will start automatically with valid credentials)
bun run start
```

### Docker Deployment

```bash
# Build and run with Docker
docker build -t igloo-server .
docker run -p 8002:8002 \
  -e GROUP_CRED="bfgroup1qqsqp..." \
  -e SHARE_CRED="bfshare1qqsqp..." \
  -e RELAYS='["wss://relay.primal.net"]' \
  igloo-server
```

## API Reference

The server provides RESTful APIs for programmatic control:

### Environment Management
```bash
# Get current configuration
GET /api/env

# Update configuration  
POST /api/env
Content-Type: application/json
{
  "GROUP_CRED": "bfgroup1...",
  "SHARE_CRED": "bfshare1...",
  "RELAYS": "[\"wss://relay.primal.net\"]"
}

# Delete configuration keys
POST /api/env/delete
Content-Type: application/json
{
  "keys": ["GROUP_CRED", "SHARE_CRED"]
}
```

### Server Status
```bash
# Get server and node status
GET /api/status

# Response:
{
  "serverRunning": true,
  "nodeActive": true,
  "hasCredentials": true,
  "relayCount": 1,
  "timestamp": "2025-01-20T12:00:00.000Z"
}
```

### Peer Management
```bash
# List peers in signing group
GET /api/peers

# Get self public key
GET /api/peers/self

# Ping specific peer
POST /api/peers/ping
Content-Type: application/json
{
  "target": "02abcd1234...peer-pubkey"
}

# Ping all peers
POST /api/peers/ping
Content-Type: application/json
{
  "target": "all"
}
```

### Real-time Events
```bash
# Subscribe to live event stream
GET /api/events
Accept: text/event-stream

# Receives events like:
data: {"type":"sign","message":"Signature request received","timestamp":"12:34:56","id":"abc123"}
data: {"type":"bifrost","message":"Peer connected","timestamp":"12:34:57","id":"def456"}
```

## Development

### Development Mode
```bash
# Start with hot reload
bun run dev

# This runs:
# - Frontend build with watch mode
# - Tailwind CSS compilation with watch mode
# - Server restart on changes (if using nodemon)
```

### Development vs Production Caching

The server automatically adjusts caching behavior based on the `NODE_ENV` environment variable:

**Development Mode** (`NODE_ENV !== 'production'`):
- Static files are read fresh from disk on each request
- No browser caching (`Cache-Control: no-cache`)
- Perfect for seeing frontend changes immediately after rebuild

**Production Mode** (`NODE_ENV=production`):
- Static files are cached in memory for performance
- Aggressive browser caching (24 hours for JS/CSS)
- Optimized for production deployment

```bash
# Force development mode (recommended for local development)
NODE_ENV=development bun start

# Force production mode
NODE_ENV=production bun start
```

### Build Commands
```bash
# Production build
bun run build          # Minified JS + CSS

# Development build (recommended for local development)
bun run build:dev      # Unminified for debugging, no server caching

# Individual builds
bun run build:js       # Frontend JavaScript only
bun run build:css     # Tailwind CSS compilation only
```

**💡 Tip**: Use `bun run build:dev` during development to avoid caching issues. The server will automatically detect non-production builds and disable static file caching.

### Frontend Structure
```
frontend/
├── index.tsx          # React app entry point
├── App.tsx           # Main app component with routing
├── components/       # Core components
│   ├── Configure.tsx # Credential configuration
│   ├── Signer.tsx    # Signing node management
│   ├── Recover.tsx   # Key recovery interface
│   └── EventLog.tsx  # Live event monitoring
├── components/ui/    # Reusable UI components
├── types/           # TypeScript definitions
└── lib/             # Utilities and helpers
```

## Built on Igloo-Core

This server leverages [@frostr/igloo-core](https://github.com/FROSTR-ORG/igloo-core) for all FROSTR protocol operations, providing:

- **Share Management** - Decode and validate FROSTR group and share credentials  
- **Bifrost Node Operations** - Enhanced connection handling with automatic retries
- **Peer Discovery & Monitoring** - Automatic peer extraction and status tracking from group credentials
- **Comprehensive Validation** - Built-in validation for all FROSTR credential types
- **Strong TypeScript Support** - Full type safety throughout the application

## Environment Variables

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `GROUP_CRED` | FROSTR group credential (bfgroup1...) | - | ✅ |
| `SHARE_CRED` | Your secret share (bfshare1...) | - | ✅ |
| `RELAYS` | JSON array of relay URLs | `["wss://relay.primal.net"]` | ❌ |
| `GROUP_NAME` | Display name for your signing group | - | ❌ |
| `ALLOWED_ORIGINS` | Comma-separated list of allowed CORS origins | `*` (all origins) | ⚠️ (Production) |
| `SESSION_SECRET` | Secret for session cookies (32+ chars) | - | ✅ (Production) |

## Troubleshooting

### Common Issues

**Build required error**: 
- Frontend build artifacts are not committed to git
- Run `bun run build` to generate required static files

**Server won't start with credentials**:
- Verify `GROUP_CRED` and `SHARE_CRED` are valid FROSTR credentials
- Check that credentials start with `bfgroup1` and `bfshare1` respectively
- Ensure relay URLs are accessible WebSocket endpoints

**Peer connection issues**:
- Verify all signers use at least one common relay
- Check firewall settings for outbound WebSocket connections  
- Timeout errors are normal when peers are offline

**Frontend not loading or changes not appearing**:
- Ensure you've run `bun run build` before starting the server
- Check that static files exist in the `static/` directory
- **For development**: Use `bun run build:dev` and `NODE_ENV=development bun start` to disable caching
- **If changes aren't showing**: The server caches static files differently in development vs production:
  - Development mode: Files read fresh from disk each time (no caching)
  - Production mode: Files cached in memory and browser for performance
- Clear browser cache if still seeing old content (Ctrl+F5 / Cmd+Shift+R)
- Restart the server after rebuilding if running in production mode

### Getting Help

- **Issues**: [GitHub Issues](https://github.com/FROSTR-ORG/igloo-server/issues)
- **FROSTR Ecosystem**: [FROSTR Organization](https://github.com/FROSTR-ORG)
- **Core Library**: [@frostr/igloo-core](https://github.com/FROSTR-ORG/igloo-core)
- **Bifrost Reference**: [Bifrost Implementation](https://github.com/FROSTR-ORG/bifrost)

## Security Configuration

Igloo Server includes comprehensive security features to protect your FROSTR credentials and signing operations:

### 🔐 **Authentication**
- **Multiple Auth Methods**: API Key, Basic Auth, Session-based authentication
- **Configurable Security**: Enable/disable authentication for development vs production
- **Rate Limiting**: IP-based request limiting to prevent abuse
- **Session Management**: Secure cookie-based sessions with configurable timeouts

### 📋 **Quick Security Setup**

**Production (Secure)**:
```bash
AUTH_ENABLED=true
API_KEY=your-secure-api-key-here
BASIC_AUTH_USER=admin
BASIC_AUTH_PASS=your-strong-password
SESSION_SECRET=your-random-64-char-session-secret-here
RATE_LIMIT_ENABLED=true
```

**Development (Local only)**:
```bash
AUTH_ENABLED=false  # Only for local development
# SESSION_SECRET=optional-for-development  # Will show warning if not set
```

### 🛡️ **Security Features**
- **Timing-safe authentication** to prevent timing attacks
- **Environment variable whitelisting** for configuration endpoints
- **Automatic session cleanup** and timeout management
- **Comprehensive rate limiting** with configurable windows and limits
- **Secure headers** and CORS configuration
- **Required SESSION_SECRET** in production to prevent session invalidation on restarts

See [SECURITY.md](SECURITY.md) for complete security configuration guide.

## Security Notes

- **Share credentials are sensitive**: Store `SHARE_CRED` securely - it's part of your nsec fragments
- **Network security**: Use WSS (secure WebSocket) relays in production  
- **Authentication required**: Configure authentication for any non-local deployment
- **CORS security**: Set `ALLOWED_ORIGINS` to specific domains in production (avoid wildcard `*`)
- **SESSION_SECRET required**: Set a strong 32+ character `SESSION_SECRET` in production to prevent session invalidation on server restarts
- **Memory management**: The relay auto-purges events to prevent memory leaks
- **HTTPS recommended**: Use a reverse proxy with TLS for production deployments

## License

MIT License - see [LICENSE](LICENSE) for details.

## Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch  
3. Make your changes with tests
4. Submit a pull request

For major changes, please open an issue first to discuss the proposed changes.
