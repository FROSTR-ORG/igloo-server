openapi: 3.1.0
info:
  title: Igloo Server API
  description: |
    A server-based signing device and personal ephemeral relay for the FROSTR protocol.

    ## Health Monitoring & Auto-Restart

    Igloo Server includes comprehensive health monitoring with automatic restart capabilities:
    - **Activity Tracking**: Monitors node activity and connection status
    - **Health Checks**: Automated health checks every 30 seconds
    - **Auto-Restart**: Automatic recovery from silent failures (5-minute watchdog)
    - **Connection Resilience**: Enhanced reconnection with exponential backoff

    ## Security Requirements

    **HTTPS is mandatory for all production deployments.** This API handles sensitive cryptographic operations and credentials that must be protected in transit.

    ## Authentication

    The Igloo Server supports multiple authentication methods:
    - **API Key**: Use `X-API-Key` header or `Authorization: Bearer <key>` (HTTPS required)
    - **Basic Auth**: Standard HTTP Basic Authentication (HTTPS strongly required)
    - **Session**: Cookie-based sessions for web UI (HTTPS required)

    **Production Recommendation:** For enhanced security in production environments, consider implementing OAuth2/OIDC flows with proper token management, rotation, and scope control.

    ## Rate Limiting

    API requests are rate limited per IP address. Default limits:
    - 100 requests per 15-minute window
    - Rate limit headers included in responses

    ## CORS

    Cross-origin requests are supported with configurable origins via `ALLOWED_ORIGINS` environment variable.
  version: 0.1.5
  contact:
    name: FROSTR Organization
    url: https://github.com/FROSTR-ORG/igloo-server
  license:
    name: MIT
    url: https://github.com/FROSTR-ORG/igloo-server/blob/master/LICENSE

servers:
  - url: https://your-domain.com
    description: Production server (HTTPS required)
  - url: http://127.0.0.1:8002
    description: Local development server (HTTP for local development only)
    x-internal-only: true

security:
  - apiKeyAuth: []
  - bearerAuth: []
  - basicAuth: []
  - sessionCookie: []
  - sessionHeader: []

paths:
  /api/status:
    get:
      operationId: getServerStatus
      summary: Get server status
      description: Returns the current status of the server and Bifrost node, including comprehensive health monitoring information
      tags:
        - Status
      security: []
      x-public: true
      responses:
        '200':
          description: Server status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerStatus'
        '400':
          $ref: '#/components/responses/BadRequest'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerStatus'
              example:
                serverRunning: true
                nodeActive: true
                hasCredentials: true
                relayCount: 2
                relays: ["wss://relay.primal.net", "wss://relay.damus.io"]
                timestamp: "2025-01-20T12:00:00.000Z"
                health:
                  isHealthy: true
                  lastActivity: "2025-01-20T11:59:30.000Z"
                  lastHealthCheck: "2025-01-20T12:00:00.000Z"
                  consecutiveFailures: 0
                  restartCount: 0
                  timeSinceLastActivity: 30000
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/auth/status:
    get:
      operationId: getAuthStatus
      summary: Get authentication status
      description: Returns the current authentication configuration and available methods
      tags:
        - Authentication
      security: []
      x-public: true
      responses:
        '200':
          description: Authentication status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthStatus'
        '400':
          $ref: '#/components/responses/BadRequest'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthStatus'
              example:
                enabled: true
                methods: ["api-key", "bearer", "basic-auth", "session"]
                rateLimiting: true
                sessionTimeout: 3600

  /api/auth/login:
    post:
      operationId: authenticateUser
      summary: Authenticate user
      description: Login with username/password or API key to get a session
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/BasicAuthLogin'
                - $ref: '#/components/schemas/ApiKeyLogin'
            examples:
              basicAuth:
                summary: Username/Password login
                value:
                  username: "admin"
                  password: "your-password"
              apiKey:
                summary: API Key login
                value:
                  apiKey: "your-api-key"
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              description: Session cookie (if session auth is configured)
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
              example:
                success: true
                sessionId: "abc123def456"
                userId: "admin"
                expiresIn: 3600
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Invalid credentials"

  /api/auth/logout:
    post:
      operationId: logoutUser
      summary: Logout user
      description: Clear the current session
      tags:
        - Authentication
      responses:
        '200':
          description: Logout successful
          headers:
            Set-Cookie:
              description: Cleared session cookie
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/env:
    get:
      operationId: getEnvironmentVariables
      summary: Get environment variables
      description: Retrieve current environment configuration (whitelisted variables only)
      tags:
        - Configuration
      responses:
        '200':
          description: Environment variables retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvironmentVariables'
              example:
                GROUP_CRED: "bfgroup1qqsqp..."
                SHARE_CRED: "bfshare1qqsqp..."
                RELAYS: ["wss://relay.primal.net"]
                GROUP_NAME: "my-signing-group"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      operationId: updateEnvironmentVariables
      summary: Update environment variables
      description: Update environment configuration (whitelisted variables only)
      tags:
        - Configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnvironmentVariables'
            example:
              GROUP_CRED: "bfgroup1qqsqp..."
              SHARE_CRED: "bfshare1qqsqp..."
              RELAYS: ["wss://relay.primal.net", "wss://relay.damus.io"]
              GROUP_NAME: "my-signing-group"
      responses:
        '200':
          description: Environment variables updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  rejectedKeys:
                    type: array
                    items:
                      type: string
                example:
                  success: true
                  message: "Environment variables updated and node restarted"
        '400':
          description: Invalid environment variables
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "No valid environment variables provided"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/env/delete:
    post:
      operationId: deleteEnvironmentVariables
      summary: Delete environment variables
      description: Remove specified environment variables
      tags:
        - Configuration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                keys:
                  type: array
                  items:
                    type: string
                  description: List of environment variable keys to delete
              required:
                - keys
            example:
              keys: ["GROUP_CRED", "SHARE_CRED"]
      responses:
        '200':
          description: Environment variables deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  deletedKeys:
                    type: array
                    items:
                      type: string
                  rejectedKeys:
                    type: array
                    items:
                      type: string
                example:
                  success: true
                  message: "Environment variables deleted"
                  deletedKeys: ["GROUP_CRED", "SHARE_CRED"]
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/peers/group:
    get:
      operationId: getPeerGroup
      summary: Get group credential metadata
      description: Return the signing group public key and quorum information
      tags:
        - Peers
      responses:
        '200':
          description: Group metadata retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  pubkey:
                    type: string
                    description: 32-byte x-only group public key (hex)
                  threshold:
                    type: integer
                    description: Number of shares required to sign
                  totalShares:
                    type: integer
                    description: Total shares in the group credential
                required: [pubkey, threshold, totalShares]
                example:
                  pubkey: "a1b2c3d4e5f6..."
                  threshold: 3
                  totalShares: 5
        '400':
          description: Missing group credential in current mode
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
  /api/peers:
    get:
      operationId: listPeers
      summary: List peers in signing group
      description: Get all peers from the group credential with their current status
      tags:
        - Peers
      responses:
        '200':
          description: Peers retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  peers:
                    type: array
                    items:
                      $ref: '#/components/schemas/PeerStatus'
                  total:
                    type: integer
                  online:
                    type: integer
                example:
                  peers:
                    - pubkey: "02abcd1234..."
                      online: true
                      lastSeen: "2025-01-20T12:00:00.000Z"
                      latency: 150
                      lastPingAttempt: "2025-01-20T11:59:00.000Z"
                    - pubkey: "03efgh5678..."
                      online: false
                      lastSeen: null
                      latency: null
                      lastPingAttempt: "2025-01-20T11:58:00.000Z"
                  total: 2
                  online: 1
        '400':
          description: No group credential available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "No group credential available"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/peers/self:
    get:
      operationId: getSelfPublicKey
      summary: Get self public key
      description: Get the public key of this node from the share credential
      tags:
        - Peers
      responses:
        '200':
          description: Self public key retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  pubkey:
                    type: string
                    description: This node's public key
                  warnings:
                    type: array
                    items:
                      type: string
                example:
                  pubkey: "02abcd1234..."
                  warnings: []
        '400':
          description: Missing credentials or could not extract pubkey
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Missing credentials"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/peers/ping:
    post:
      operationId: pingPeers
      summary: Ping peers
      description: Ping specific peer or all peers to check connectivity
      tags:
        - Peers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                target:
                  oneOf:
                    - type: string
                      enum: ["all"]
                    - type: string
                      pattern: "^(02|03)[a-fA-F0-9]{64}$"
                  description: Either "all" to ping all peers, or a specific peer's public key
              required:
                - target
            examples:
              pingAll:
                summary: Ping all peers
                value:
                  target: "all"
              pingSpecific:
                summary: Ping specific peer
                value:
                  target: "031234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
      responses:
        '200':
          description: Ping completed successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/PingResult'
                  - type: array
                    items:
                      $ref: '#/components/schemas/PingResult'
              examples:
                singlePing:
                  summary: Single peer ping result
                  value:
                    success: true
                    pubkey: "02abcd1234..."
                    latency: 150
                    policy:
                      send: true
                      recv: true
                    timestamp: "2025-01-20T12:00:00.000Z"
                allPings:
                  summary: All peers ping results
                  value:
                    - success: true
                      pubkey: "02abcd1234..."
                      latency: 150
                      policy:
                        send: true
                        recv: true
                      timestamp: "2025-01-20T12:00:00.000Z"
                    - success: false
                      pubkey: "03efgh5678..."
                      error: "Timeout"
                      timestamp: "2025-01-20T12:00:05.000Z"
        '400':
          description: Invalid target parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Invalid target parameter"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          description: Node not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Node not available"

  /api/recover:
    post:
      operationId: recoverSecretKey
      summary: Recover secret key from shares
      description: Use threshold shares to recover the original secret key
      tags:
        - Key Recovery
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                groupCredential:
                  type: string
                  description: Group credential (bfgroup1...)
                  pattern: "^bfgroup1"
                shareCredentials:
                  type: array
                  items:
                    type: string
                    pattern: "^bfshare1"
                  description: Array of share credentials (bfshare1...)
                  minItems: 1
              required:
                - groupCredential
                - shareCredentials
            example:
              groupCredential: "bfgroup1qqsqp..."
              shareCredentials:
                - "bfshare1qqsqp..."
                - "bfshare1qqsqp..."
      responses:
        '200':
          description: Secret key recovered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  nsec:
                    type: string
                    description: Recovered secret key in nsec format
                  details:
                    type: object
                    properties:
                      sharesUsed:
                        type: integer
                      thresholdRequired:
                        type: integer
                      invalidShares:
                        type: array
                        items:
                          type: object
                          properties:
                            index:
                              type: integer
                            error:
                              type: string
                example:
                  success: true
                  nsec: "nsec1abc123..."
                  details:
                    sharesUsed: 2
                    thresholdRequired: 2
        '400':
          description: Invalid credentials or insufficient shares
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  error:
                    type: string
                  details:
                    type: object
                example:
                  success: false
                  error: "Insufficient shares: need 2, got 1"
                  details:
                    provided: 1
                    required: 2
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: Recovery failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  error:
                    type: string
                example:
                  success: false
                  error: "Recovery failed: Invalid shares"

  /api/recover/validate:
    post:
      operationId: validateCredentials
      summary: Validate credentials
      description: Validate group or share credentials without performing recovery
      tags:
        - Key Recovery
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: string
                  enum: ["group", "share"]
                  description: Type of credential to validate
                credential:
                  type: string
                  description: The credential to validate
              required:
                - type
                - credential
            examples:
              validateGroup:
                summary: Validate group credential
                value:
                  type: "group"
                  credential: "bfgroup1qqsqp..."
              validateShare:
                summary: Validate share credential
                value:
                  type: "share"
                  credential: "bfshare1qqsqp..."
      responses:
        '200':
          description: Validation completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  validation:
                    type: object
                    properties:
                      isValid:
                        type: boolean
                      message:
                        type: string
                  decoded:
                    type: object
                    properties:
                      threshold:
                        type: [integer, "null"]
                      totalShares:
                        type: [integer, "null"]
                      idx:
                        type: [integer, "null"]
                example:
                  success: true
                  validation:
                    isValid: true
                  decoded:
                    threshold: 2
                    totalShares: 3
                    idx: null
        '400':
          description: Invalid request or credential type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Invalid type. Must be 'group' or 'share'"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/shares:
    get:
      operationId: getStoredShares
      summary: Get stored shares
      description: Retrieve currently stored share information
      tags:
        - Share Management
      responses:
        '200':
          description: Shares retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StoredShare'
              example:
                - shareCredential: "bfshare1qqsqp..."
                  groupCredential: "bfgroup1qqsqp..."
                  savedAt: "2025-01-20T12:00:00.000Z"
                  id: "env-stored-share"
                  source: "environment"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      operationId: storeNewShare
      summary: Store new share
      description: Save share and group credentials
      tags:
        - Share Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                shareCredential:
                  type: string
                  pattern: "^bfshare1"
                  description: Share credential to store
                groupCredential:
                  type: string
                  pattern: "^bfgroup1"
                  description: Group credential to store
              required:
                - shareCredential
                - groupCredential
            example:
              shareCredential: "bfshare1qqsqp..."
              groupCredential: "bfgroup1qqsqp..."
      responses:
        '200':
          description: Share saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                example:
                  success: true
                  message: "Share saved successfully"
        '400':
          description: Missing or invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Invalid credentials provided"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: Failed to save share
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error: "Failed to save share"

  /api/events:
    get:
      operationId: getEventStream
      summary: Server-Sent Events stream
      description: |
        Subscribe to real-time server events using Server-Sent Events.

        Events include:
        - `system`: Server status changes
        - `sign`: Signature requests and responses
        - `bifrost`: Peer connections and network events
        - `ecdh`: ECDH protocol events

        Note: This endpoint uses Server-Sent Events (SSE) and requires EventSource client.
      tags:
        - Events
      responses:
        '200':
          description: Event stream established
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-Sent Events stream
              example: |
                data: {"type":"system","message":"Connected to event stream","timestamp":"12:34:56","id":"abc123"}

                data: {"type":"sign","message":"Signature request received","timestamp":"12:35:01","id":"def456"}

                data: {"type":"bifrost","message":"Peer connected","timestamp":"12:35:03","id":"ghi789"}
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/sign:
    post:
      operationId: signEvent
      summary: Threshold sign a Nostr event ID
      description: |
        Creates a Schnorr signature for a Nostr event ID using FROSTR threshold signing. Provide either `message` (32-byte hex id) or an `event` template with a valid 64-hex `pubkey`.
      security:
        - apiKeyAuth: []
        - bearerAuth: []
        - basicAuth: []
        - sessionCookie: []
        - sessionHeader: []
      tags:
        - Crypto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignRequest'
      responses:
        '200':
          description: Signature produced
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '504':
          description: Signing timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '502':
          $ref: '#/components/responses/BadGateway'
        '503':
          $ref: '#/components/responses/ServiceUnavailable'

  /api/nip44/encrypt:
    post:
      operationId: nip44Encrypt
      summary: Encrypt with NIP‑44 (ECDH + symmetric)
      tags: [Crypto]
      security:
        - apiKeyAuth: []
        - bearerAuth: []
        - basicAuth: []
        - sessionCookie: []
        - sessionHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Nip44Request'
      responses:
        '200':
          description: Ciphertext
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NipXXResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '429': { $ref: '#/components/responses/TooManyRequests' }
        '504':
          description: ECDH timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503': { $ref: '#/components/responses/ServiceUnavailable' }

  /api/nip44/decrypt:
    post:
      operationId: nip44Decrypt
      summary: Decrypt with NIP‑44
      tags: [Crypto]
      security:
        - apiKeyAuth: []
        - bearerAuth: []
        - basicAuth: []
        - sessionCookie: []
        - sessionHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Nip44Request'
      responses:
        '200':
          description: Plaintext
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NipXXResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '429': { $ref: '#/components/responses/TooManyRequests' }
        '504':
          description: ECDH timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503': { $ref: '#/components/responses/ServiceUnavailable' }

  /api/nip04/encrypt:
    post:
      operationId: nip04Encrypt
      summary: Encrypt with NIP‑04 (legacy; less secure than NIP‑44)
      tags: [Crypto]
      security:
        - apiKeyAuth: []
        - bearerAuth: []
        - basicAuth: []
        - sessionCookie: []
        - sessionHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Nip04Request'
      responses:
        '200':
          description: Ciphertext
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NipXXResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '429': { $ref: '#/components/responses/TooManyRequests' }
        '504':
          description: ECDH timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503': { $ref: '#/components/responses/ServiceUnavailable' }

  /api/nip04/decrypt:
    post:
      operationId: nip04Decrypt
      summary: Decrypt with NIP‑04
      tags: [Crypto]
      security:
        - apiKeyAuth: []
        - bearerAuth: []
        - basicAuth: []
        - sessionCookie: []
        - sessionHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Nip04Request'
      responses:
        '200':
          description: Plaintext
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NipXXResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '429': { $ref: '#/components/responses/TooManyRequests' }
        '504':
          description: ECDH timed out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503': { $ref: '#/components/responses/ServiceUnavailable' }

  /api/nip46/sessions:
    get:
      operationId: listNip46Sessions
      summary: List NIP‑46 sessions
      tags: [NIP‑46]
      parameters:
        - in: query
          name: history
          schema: { type: boolean }
          description: Include recent_kinds/methods summary
      responses:
        '200':
          description: Sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Nip46Session'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'
    post:
      operationId: upsertNip46Session
      summary: Create or update a NIP‑46 session
      tags: [NIP‑46]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Nip46SessionInput'
      responses:
        '200':
          description: Upserted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  session: { $ref: '#/components/schemas/Nip46Session' }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'

  /api/nip46/sessions/{pubkey}/policy:
    put:
      operationId: updateNip46Policy
      summary: Update session policy
      tags: [NIP‑46]
      parameters:
        - $ref: '#/components/parameters/PubkeyParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Nip46Policy'
      responses:
        '200': { description: Updated }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/nip46/sessions/{pubkey}/status:
    put:
      operationId: updateNip46Status
      summary: Update session status (revoked deletes)
      tags: [NIP‑46]
      parameters:
        - $ref: '#/components/parameters/PubkeyParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [pending, active, revoked]
                touch:
                  type: boolean
                  description: Update last_active_at when true
      responses:
        '200': { description: Updated or deleted }
        '404': { $ref: '#/components/responses/NotFound' }

  /api/nip46/sessions/{pubkey}:
    delete:
      operationId: deleteNip46Session
      summary: Delete a NIP‑46 session
      tags: [NIP‑46]
      parameters:
        - $ref: '#/components/parameters/PubkeyParam'
      responses:
        '200':
          description: Deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/nip46/history:
    get:
      operationId: nip46History
      summary: Compact NIP‑46 history summary
      tags: [NIP‑46]
      responses:
        '200':
          description: History
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Nip46SessionSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/admin/api-keys:
    get:
      operationId: listAdminApiKeys
      summary: List API keys
      description: |
        Returns metadata for all API keys managed in database mode.

        Authentication: provide `ADMIN_SECRET` as a Bearer token, or use a valid session for an admin user (first user or `role=admin`).
      tags: [Admin]
      security:
        - bearerAuth: []
        - sessionHeader: []
        - sessionCookie: []
      responses:
        '200':
          description: API key metadata retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminApiKeyListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      operationId: createAdminApiKey
      summary: Create API key
      description: |
        Creates a new API key and returns the token once.

        Authentication: provide `ADMIN_SECRET` as a Bearer token, or use a valid session for an admin user (first user or `role=admin`).
      tags: [Admin]
      security:
        - bearerAuth: []
        - sessionHeader: []
        - sessionCookie: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminApiKeyCreateRequest'
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminApiKeyCreateResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /api/admin/api-keys/revoke:
    post:
      operationId: revokeAdminApiKey
      summary: Revoke API key
      description: |
        Revokes an existing API key by ID.

        Authentication: provide `ADMIN_SECRET` as a Bearer token, or use a valid session for an admin user (first user or `role=admin`).
      tags: [Admin]
      security:
        - bearerAuth: []
        - sessionHeader: []
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdminApiKeyRevokeRequest'
      responses:
        '200':
          description: API key revoked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    const: true
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    apiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key authentication via X-API-Key header.

        **Security Requirements:**
        - HTTPS is mandatory in production environments
        - API keys must be transmitted over encrypted connections only
        - Never include API keys in URL query parameters

        **Recommended for Production:**
        Consider implementing OAuth2/OIDC flows for enhanced security and token management in sensitive production environments.

    bearerAuth:
      type: http
      scheme: bearer
      description: |
        Bearer token authentication (alternative to X-API-Key header).

        **Security Requirements:**
        - HTTPS is mandatory in production environments
        - Bearer tokens must be transmitted over encrypted connections only
        - Never include bearer tokens in URL query parameters

        **Recommended for Production:**
        OAuth2/OIDC bearer tokens provide better security, token rotation, and scope management compared to static API keys.

    basicAuth:
      type: http
      scheme: basic
      description: |
        HTTP Basic Authentication using username and password.

        **Security Requirements:**
        - HTTPS is absolutely critical - Basic Auth transmits credentials in Base64 encoding (not encryption)
        - Never use Basic Auth over HTTP in production as credentials are easily intercepted
        - Credentials are sent with every request, increasing exposure risk

        **Production Recommendation:**
        Basic Auth is discouraged for production use. Implement OAuth2/OIDC with proper token-based authentication for enhanced security, session management, and credential protection.

    sessionHeader:
      type: apiKey
      in: header
      name: X-Session-ID
      description: |
        Session-based authentication via the `X-Session-ID` header.

        **Security Requirements:**
        - HTTPS is mandatory to protect session identifiers from interception
        - Treat the header value like a credential and avoid logging it

        **Best Practices:**
        - Combine with Secure/HttpOnly cookies when possible
        - Implement CSRF protection for browser-based clients

    sessionCookie:
      type: apiKey
      in: cookie
      name: session
      description: |
        Session-based authentication via HttpOnly cookie.

        **Security Requirements:**
        - HTTPS is mandatory so cookies are only sent over encrypted channels
        - Cookies should be issued with Secure, HttpOnly, and SameSite attributes where appropriate

        **Best Practices:**
        - Rotate session identifiers regularly
        - Combine with CSRF protections when the cookie is used in browsers

  schemas:
    ServerStatus:
      type: object
      properties:
        serverRunning:
          type: boolean
          description: Whether the server is running
        nodeActive:
          type: boolean
          description: Whether the Bifrost node is active
        hasCredentials:
          type: boolean
          description: Whether FROSTR credentials are configured
        relayCount:
          type: integer
          description: Number of configured relays
        relays:
          type: array
          items:
            type: string
            format: uri
          description: List of configured relay URLs
        timestamp:
          type: string
          format: date-time
          description: Current server timestamp
        health:
          type: object
          properties:
            isHealthy:
              type: boolean
              description: Whether the node is considered healthy
            lastActivity:
              type: [string, "null"]
              format: date-time
              description: Timestamp of last node activity
            lastHealthCheck:
              type: [string, "null"]
              format: date-time
              description: Timestamp of last health check
            consecutiveFailures:
              type: integer
              description: Number of consecutive health check failures
            restartCount:
              type: integer
              description: Total number of automatic restarts
            timeSinceLastActivity:
              type: [integer, "null"]
              description: Milliseconds since last activity
          required:
            - isHealthy
            - lastActivity
            - lastHealthCheck
            - consecutiveFailures
            - restartCount
            - timeSinceLastActivity
          description: Node health monitoring information
      required:
        - serverRunning
        - nodeActive
        - hasCredentials
        - relayCount
        - relays
        - timestamp
        - health

    AuthStatus:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether authentication is enabled
        methods:
          type: array
          items:
            type: string
            enum: ["api-key", "bearer", "basic-auth", "session"]
          description: Available authentication methods
        rateLimiting:
          type: boolean
          description: Whether rate limiting is enabled
        sessionTimeout:
          type: integer
          description: Session timeout in seconds (dynamic based on configuration)
      required:
        - enabled
        - methods
        - rateLimiting
        - sessionTimeout

    BasicAuthLogin:
      type: object
      properties:
        username:
          type: string
          description: Username for basic authentication
        password:
          type: string
          description: Password for basic authentication
      required:
        - username
        - password

    ApiKeyLogin:
      type: object
      properties:
        apiKey:
          type: string
          description: API key for authentication
      required:
        - apiKey

    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
        sessionId:
          type: string
          description: Session ID (if session auth is configured)
        userId:
          type: string
          description: User identifier
        expiresIn:
          type: integer
          description: Session expiration time in seconds
        warning:
          type: string
          description: Warning message (if session creation failed)
      required:
        - success
        - userId

    EnvironmentVariables:
      type: object
      properties:
        GROUP_CRED:
          type: string
          description: FROSTR group credential
          pattern: "^bfgroup1"
        SHARE_CRED:
          type: string
          description: FROSTR share credential
          pattern: "^bfshare1"
        RELAYS:
          type: array
          items:
            type: string
            format: uri
            pattern: "^wss?://"
          description: Array of relay URLs (WebSocket URLs)
          maxItems: 20
          minItems: 1
        GROUP_NAME:
          type: string
          description: Display name for the signing group
      additionalProperties: false

    PeerStatus:
      type: object
      properties:
        pubkey:
          type: string
          description: Peer's public key
          pattern: "^(02|03)[a-fA-F0-9]{64}$"
        online:
          type: boolean
          description: Whether the peer is currently online
        lastSeen:
          type: [string, "null"]
          format: date-time
          description: Last time peer was seen online
        latency:
          type: [integer, "null"]
          description: Last measured latency in milliseconds
        lastPingAttempt:
          type: [string, "null"]
          format: date-time
          description: Last ping attempt timestamp
      required:
        - pubkey
        - online

    PingResult:
      type: object
      properties:
        success:
          type: boolean
          description: Whether the ping was successful
        pubkey:
          type: string
          description: Target peer's public key
        latency:
          type: [integer, "null"]
          description: Round-trip time in milliseconds
        policy:
          type: [object, "null"]
          properties:
            send:
              type: boolean
              description: Whether peer accepts messages from us
            recv:
              type: boolean
              description: Whether we accept messages from peer
        error:
          type: [string, "null"]
          description: Error message if ping failed
        timestamp:
          type: string
          format: date-time
          description: Ping timestamp
      required:
        - success
        - pubkey
        - timestamp

    StoredShare:
      type: object
      properties:
        shareCredential:
          type: string
          description: The share credential
        groupCredential:
          type: string
          description: The group credential
        savedAt:
          type: string
          format: date-time
          description: When the share was saved
        id:
          type: string
          description: Unique identifier for the share
        source:
          type: string
          description: Source of the share (e.g., "environment")
      required:
        - shareCredential
        - groupCredential
        - savedAt
        - id
        - source

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
        success:
          type: boolean
          description: Always false for error responses
      required:
        - error

    SignRequest:
      type: object
      oneOf:
        - type: object
          properties:
            message:
              type: string
              pattern: '^[0-9a-fA-F]{64}$'
          required: [message]
        - type: object
          properties:
            event:
              $ref: '#/components/schemas/EventTemplateInput'
          required: [event]

    EventTemplateInput:
      type: object
      properties:
        pubkey:
          type: string
          description: 64-hex x-only pubkey
          pattern: '^[0-9a-fA-F]{64}$'
        kind:
          type: integer
        created_at:
          type: integer
        content:
          type: string
        tags:
          type: array
          items:
            type: array
            items:
              type: string
      required: [pubkey, kind, created_at]

    SignResponse:
      type: object
      properties:
        id:
          type: string
          description: Event id (32-byte hex)
        signature:
          type: string
          description: Schnorr signature (64-byte hex)
      required: [id, signature]

    Nip44Request:
      type: object
      description: Request body for NIP‑44 encryption/decryption operations
      properties:
        peer_pubkey:
          type: string
          description: 32-byte x-only pubkey (or 33-byte compressed)
          pattern: '^[0-9a-fA-F]{64}$|^[0-9a-fA-F]{66}$'
        content:
          type: string
          description: |
            Payload to process (plaintext for encrypt, ciphertext for decrypt).
            Maximum plaintext length: 65,535 bytes; encrypted/padded blob may reach 65,536 bytes.
            Minimum plaintext: 1 byte (padded to 32 bytes).
            Implementations should split messages larger than 65,535 bytes.
      required: [peer_pubkey, content]

    Nip04Request:
      $ref: '#/components/schemas/Nip44Request'

    NipXXResponse:
      type: object
      properties:
        result:
          type: string
          description: >-
            Result payload. Encrypt endpoints return base64-encoded ciphertext
            (for NIP-04 the value includes a '?iv=' suffix with a base64 IV),
            while decrypt endpoints return UTF-8 plaintext. Clients must decode
            according to the endpoint invoked.
      required: [result]

    Nip46Policy:
      type: object
      properties:
        methods:
          type: object
          additionalProperties:
            type: boolean
        kinds:
          type: object
          additionalProperties:
            type: boolean

    Nip46Profile:
      type: object
      properties:
        name: { type: string }
        url: { type: string }
        image: { type: string }

    Nip46SessionInput:
      type: object
      description: Client-supplied fields when creating or updating a NIP‑46 session
      properties:
        client_pubkey:
          type: string
          description: Client public key (hex encoded)
        status:
          type: string
          enum: [pending, active, revoked]
          description: Desired session status (defaults to pending)
        profile:
          $ref: '#/components/schemas/Nip46Profile'
        relays:
          type: array
          items: { type: string }
          description: Preferred relays for the session
        policy:
          $ref: '#/components/schemas/Nip46Policy'
      required: [client_pubkey]

    Nip46Session:
      type: object
      description: Full persisted NIP‑46 session details
      properties:
        pubkey: { type: string }
        status:
          type: string
          enum: [pending, active, revoked]
        profile:
          $ref: '#/components/schemas/Nip46Profile'
        relays:
          type: [array, "null"]
          items: { type: string }
        policy:
          $ref: '#/components/schemas/Nip46Policy'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        last_active_at:
          type: string
          format: date-time
          description: Timestamp of the most recent activity, if available.

    Nip46SessionSummary:
      type: object
      description: Compact summary of a NIP‑46 session for history views
      properties:
        pubkey: { type: string }
        status: { type: string }
        last_active_at:
          type: string
          format: date-time
          description: Timestamp of the most recent activity, when available.
        profile: { $ref: '#/components/schemas/Nip46Profile' }
        recent_kinds:
          type: array
          items: { type: integer }
          description: Recently granted Nostr kind identifiers
        recent_methods:
          type: array
          items: { type: string }

    AdminApiKey:
      type: object
      description: Metadata about an API key managed in database mode
      properties:
        id:
          oneOf:
            - type: integer
            - type: string
          description: Database identifier for the API key
        prefix:
          type: string
          description: Public prefix of the API key (first 12 characters)
        label:
          type: [string, "null"]
          description: Optional label describing the API key's purpose
        createdAt:
          type: string
          description: Creation timestamp (SQLite ISO format)
        updatedAt:
          type: string
          description: Last update timestamp
        lastUsedAt:
          type: [string, "null"]
          description: Timestamp of the most recent successful authentication using this key
        lastUsedIp:
          type: [string, "null"]
          description: IP address of the most recent successful authentication
        revokedAt:
          type: [string, "null"]
          description: Timestamp when the key was revoked
        revokedReason:
          type: [string, "null"]
          description: Optional reason supplied during revocation
        createdByUserId:
          type: [integer, string, "null"]
          description: User ID associated with the key (if created on behalf of a user)
        createdByAdmin:
          type: boolean
          description: Indicates whether the key was created directly by an administrator
      required:
        - id
        - prefix
        - createdAt
        - updatedAt
        - createdByAdmin

    AdminApiKeyListResponse:
      type: object
      properties:
        apiKeys:
          type: array
          items:
            $ref: '#/components/schemas/AdminApiKey'
      required:
        - apiKeys

    AdminApiKeyCreateRequest:
      type: object
      properties:
        label:
          type: string
          description: Optional label assigned to the API key
          maxLength: 128
        userId:
          oneOf:
            - type: integer
            - type: string
          description: Optional user ID to associate with the key
        createdByAdmin:
          type: boolean
          description: Override automatic admin attribution (defaults to true when userId is omitted)

    AdminApiKeyCreateResponse:
      type: object
      properties:
        apiKey:
          type: object
          properties:
            id:
              oneOf:
                - type: integer
                - type: string
              description: Database identifier for the new key
            token:
              type: string
              description: Full API key value (only returned at creation time)
            prefix:
              type: string
              description: Public prefix of the new API key
            label:
              type: [string, "null"]
              description: Applied label, if any
            createdByUserId:
              type: [integer, string, "null"]
              description: Associated user ID when the key is created on behalf of a user
            createdByAdmin:
              type: boolean
              description: Indicates whether the key was created directly by an administrator
          required:
            - id
            - token
            - prefix
            - createdByAdmin
      required:
        - apiKey

    AdminApiKeyRevokeRequest:
      type: object
      properties:
        apiKeyId:
          oneOf:
            - type: integer
            - type: string
          description: Identifier of the API key to revoke
        reason:
          type: string
          description: Optional revocation reason
          maxLength: 256
      required:
        - apiKeyId

  responses:
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/ErrorResponse'
              - type: object
                properties:
                  authMethods:
                    type: array
                    items:
                      type: string
          example:
            error: "Authentication required"
            authMethods: ["api-key", "bearer", "basic-auth", "session"]

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Internal server error"
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: Conflict with current state
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    BadRequest:
      description: Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    BadGateway:
      description: Upstream error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    ServiceUnavailable:
      description: Node not available
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
  parameters:
    PubkeyParam:
      name: pubkey
      in: path
      required: true
      schema:
        type: string
      description: Session client pubkey (hex)

tags:
  - name: Status
    description: Server and node status endpoints
  - name: Authentication
    description: Authentication and session management
  - name: Configuration
    description: Environment variable management
  - name: Peers
    description: Peer discovery and connectivity
  - name: Key Recovery
    description: Secret key recovery from threshold shares
  - name: Share Management
    description: Share storage and management
  - name: Events
    description: Real-time event streaming
  - name: Admin
    description: Administrative endpoints requiring ADMIN_SECRET
